# 📄 `ADR-001.md` (アーキテクチャ決定記録)

** アーキテクチャ名**: 監査可能な実行サイクルを核とする実装アーキテクチャ

**Status**: Accepted
**Date**: 2025-08-11
**Version**: 4.6

-----

## 概要 (Executive Summary)

本ドキュメントは、高頻度・高変動なAI活用環境における、**再現性・監査性・統制**を確立するための統一アーキテクチャを定義する。このアーキテクチャは、自律的に動作する**「プロジェクト心臓部 (Project Heart)」**と、組織横断で品質を保証する**「ガバナンスレイヤー (Governance Layer)」**の二層構造を核とする。

特に、**非公開の書籍リポジトリ（心臓部）が、その成果物として公開用のハンズオンリポジトリ**をAIによって自動生成・管理する運用モデルを想定している。

-----

## 1. 背景 (Context)

高頻度かつ高変動なAI活用環境において、再現性、因果関係、客観的データ、ガバナンス適用の課題が顕在化している。これらは、AI協働が本格運用に移行する際の重大な障壁となっている。

-----

## 2. 採用決定 (Decision)

**「プロジェクト心臓部」**と**「ガバナンスレイヤー」**から成る二層アーキテクチャを採用する。全てのAI関連活動は、次項で定義する「監査可能な実行サイクル」の原則に厳密に従うものとする。

-----

## 3. 中核原則: 監査可能な実行サイクル

全てのAI実行において、以下の4要素の記録を必須とし、完全なトレーサビリティを確保する。

1.  **Why_Pinning**: 活動の目的 (**`charter/`** ディレクトリ)
2.  **Prompt_SSOT**: AIへの指示 (プロンプトファイル)
3.  **Context_Snapshot**: 実行時のWhyとプロンプトのバージョン情報 (ハッシュ)
4.  **Complete_IO_Log**: AIへの入力と出力の完全なログ

-----

## 4. アーキテクチャ Pillar I: プロジェクト心臓部（Project Heart）

各プロジェクトの自律性と再現性を担保するコンポーネント群。これは主に**非公開（Private）の書籍リポジトリ**として運用される。

### 4.1 SSOT: `charter/` ディレクトリ (プロジェクトの憲法)

プロジェクトの**唯一の真実の源 (Single Source of Truth)** として **`charter/` ディレクトリ**を定義する。このディレクトリは、プロジェクトの「憲法」を構成する、複数の定義ファイルを格納します。これにより、関心事の分離と高い保守性を実現します。

格納されるファイルの代表例は以下の通りです。

  * **`charter.md` (憲章)**: プロジェクト全体の目的、ゴール、存在意義を定義する、このディレクトリの核となるファイルです。
  * **`outline.yaml` (アウトライン)**: 書籍やプロダクトの章立て、構造を定義します。
  * **`personas.yaml` (ペルソナ)**: ターゲットとなる読者やユーザーの具体的な人物像を定義します。
  * **`style-guide.yaml` (スタイルガイド)**: プロジェクト固有の文体、トーン、専門用語の表記ルールなどを定義します。
  * **`workflow.yaml` (ワークフロー)**: 執筆からレビュー、公開までの固有の作業プロセスを定義します。
  * **`hands-on-spec.md` (ハンズオン仕様書)**: 成果物として生成されるハンズオンリポジトリの、AI向け詳細仕様書です。

### 4.2 ディレクトリ構造

「心臓部」の標準構成は以下の通り。

```
book-repository/ (Private)
├── .github/
│   └── workflows/
│       └── ci.yml
├── charter/             # プロジェクトの憲法 (詳細は4.1参照)
├── prompts/
├── records/
└── scripts/
    ├── plan_tasks.py        # 1. 計画タスク
    ├── produce_artifact.py  # 2. 製造タスク
    └── verify_artifact.py   # 3. 検証タスク
```

### 4.3 実行エンジンの役割 (Plan-Produce-Verify)

`scripts/`配下のスクリプト群は、知識生産の組立ラインとして**「計画・製造・検証」**の3つのフェーズを担う。

  * **1. 計画 (Plan)**: `plan_tasks.py`が`charter/`を読み解き、実行可能なタスクリストを`records/tasks/`に生成する。
  * **2. 製造 (Produce)**: `produce_artifact.py`がタスクに基づき、単体テストを含めながらコンテンツやコードといった成果物を生成する。
  * **3. 検証 (Verify)**: `verify_artifact.py`が、製造された成果物をペルソナやスタイルガイド等の定性的な観点からレビューする。

### 4.4 プロジェクトの成果物

本プロジェクト（書籍リポジトリ）は、それ自体がコンテンツであると同時に、他の成果物を生成する責務を持つ。主な関係性は以下の通り。

  * **書籍リポジトリ (Private)**:
      * コンテンツの執筆、校正、管理を行う。
      * `charter/`内の仕様書に基づき、ハンズオンリポジトリを**生成・更新するAIプロセス**を持つ。
  * **ハンズオンリポジトリ (Public)**:
      * 書籍リポジトリのAIプロセスによって**自動生成される成果物 (Artifact)**。
      * 読者が実際に手を動かして学べる、公開されたコードベース。

この分離モデルにより、執筆プロセスや未公開の草稿といった機密情報を非公開に保ちつつ、学習用の成果物だけをクリーンな状態で公開できる。

-----

## 5. アーキテクチャ Pillar II: ガバナンスレイヤー（Governance Layer）

組織全体の品質と一貫性を担保する、中央集権的なサービスレイヤー。書籍リポジトリと、そこから生成されるハンズオンリポジトリの両方に、共通の品質ゲートを適用する。

### 5.1 目的と位置づけ

ガバナンスリポジトリは、個別プロジェクトから独立しており、組織内の全プロジェクトに**一貫した品質保証ゲートを「サービスとして」提供する**。これは、各プロジェクトの`ci.yml`からGitHub Actionsの再利用ワークフロー (`uses: org/governance/...`) として呼び出される。

### 5.2 ディレクトリ構成（ガバナンスリポジトリ）

再利用可能な機能の提供に特化した最小構成は以下の通り。

```
governance-repo/
├── .github/
│   └── workflows/
│       └── immune.yml
├── policy/
│   ├── rules/
│   │   └── common-rules.yaml
│   └── schemas/
│       └── adr.schema.json
├── adr/
└── charter/
```

### 5.3 主要コンポーネントの役割

  * **`immune.yml` (中央司令塔)**: 各プロジェクトから呼び出される再利用可能なCIワークフロー本体。
  * **`policy/` (法律/施行規則)**: CIが使用する共通のルール（例: 文章スタイル）やスキーマ定義を格納する。
  * **`adr/`, `charter/` (憲法/議事録)**: ガバナンスシステム自体の**目的（Why）と設計経緯（How）**を記録し、透明性と監査性を確保する。

-----

## 6. 運用モデルとライフサイクル

### 6.1 変更管理プロセス

「憲法」である **`charter/` ディレクトリ**内のファイル群への変更は、軽量なPRプロセス、またはADRを伴う厳格なプロセスのいずれかを必須とする。

### 6.2 タスクのライフサイクル管理

タスクの進捗 (`Pending` → `InReview` → `Done`) は、GitHubイベントをトリガーにCI/CDパイプラインが`records/tasks/`配下の台帳を自動更新することで管理される。

### 6.3 修正指示プロトコル

人間がAIの成果物を修正する際は、PR上で`/correct`コマンドを実行する。これにより、人間による介入も全て監査可能な記録として残る。

### 6.4 成熟度モデル

本アーキテクチャは、**Level 0 (手動)**から**Level 4 (自己進化)**までの5段階の成熟度モデルに沿って、段階的に導入・進化させる。

-----

## 7. 影響と成果 (Impact and Outcomes)

### 7.1 影響分析 (Consequences)

  * **Positive**: 完全な監査証跡、再現性の保証、ガバナンスの自動化。憲法ファイルの保守性向上。
  * **Negative**: ストレージコスト増大、初期設定の手間、学習曲線。

### 7.2 期待される成果

  * **定量的効果**: 人間介入率の削減、品質保証時間の短縮。
  * **定性的効果**: エンジニアの創造的業務への集中、品質の一貫性保証。
